!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unroutableQueryStringKeys=t.referrerUrlQueryStringKey=t.marketingVariantQueryStringKey=t.marketingScreenVariantQueryStringKey=t.subscribeQueryStringKey=t.messageQueryStringKey=t.extensionInstalledQueryStringKey=t.extensionAuthQueryStringKey=t.deviceTypeQueryStringKey=t.clientTypeQueryStringKey=t.authServiceTokenQueryStringKey=t.appReferralQueryStringKey=t.createQueryString=t.parseQueryString=void 0,t.parseQueryString=function(e){return e?(e.startsWith("?")&&(e=e.substring(1)),e.split("&").reduce((function(e,t){var r=t.split("=");return e[decodeURIComponent(r[0])]=decodeURIComponent(r[1]),e}),{})):{}},t.createQueryString=function(e){if(e){var t=Object.keys(e).reduce((function(t,r){var n=encodeURIComponent(r),o=e[r];return null==o?t.push(n):"string"==typeof o||"number"==typeof o||"boolean"==typeof o?t.push(n+"="+encodeURIComponent(o)):Array.isArray(o)&&o.forEach((function(e){t.push(n+"="+encodeURIComponent(e))})),t}),[]);if(t.length)return"?"+t.join("&")}return""},t.appReferralQueryStringKey="appReferral",t.authServiceTokenQueryStringKey="authServiceToken",t.clientTypeQueryStringKey="clientType",t.deviceTypeQueryStringKey="deviceType",t.extensionAuthQueryStringKey="extensionAuth",t.extensionInstalledQueryStringKey="extensionInstalled",t.messageQueryStringKey="message",t.subscribeQueryStringKey="subscribe",t.marketingScreenVariantQueryStringKey="marketingScreenVariant",t.marketingVariantQueryStringKey="marketingVariant",t.referrerUrlQueryStringKey="referrerUrl",t.unroutableQueryStringKeys=[t.appReferralQueryStringKey,t.authServiceTokenQueryStringKey,t.clientTypeQueryStringKey,t.deviceTypeQueryStringKey,t.extensionAuthQueryStringKey,t.extensionInstalledQueryStringKey,t.messageQueryStringKey,t.subscribeQueryStringKey,t.marketingScreenVariantQueryStringKey,t.marketingVariantQueryStringKey,t.referrerUrlQueryStringKey]},function(e,t,r){"use strict";var n,o=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(t,r,n){void 0===n&&(n="localStorage");var o=e.call(this,t,[],n)||this;return o._getKey=r,o}return o(t,e),t.prototype._getItemByKey=function(e,t){var r=this;return t.filter((function(t){return r._getKey(t)===e}))[0]},t.prototype._removeItem=function(e,t){t.splice(t.indexOf(e),1)},t.prototype.get=function(e){return this._getItemByKey(e,this._read())},t.prototype.getAll=function(){return this._read()},t.prototype.set=function(e){var t=this._read(),r=this._getItemByKey(this._getKey(e),t);return r&&this._removeItem(r,t),t.push(e),this._write(t),e},t.prototype.remove=function(e){var t=this._read(),r=this._getItemByKey(e,t);return r&&(this._removeItem(r,t),this._write(t)),r},t}(r(2).default);t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,r){var n=this;if(void 0===r&&(r="localStorage"),this._eventListeners=[],this._defaultValue=t,function(e){void 0===e&&(e="localStorage");try{var t=window[e],r="__storage_test__";return t.setItem(r,r),t.removeItem(r),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==t.length}}(r)){var o;switch(r){case"localStorage":o=localStorage;break;case"sessionStorage":o=sessionStorage}this._storage={read:function(){return JSON.parse(o.getItem(e))},write:function(t){o.setItem(e,JSON.stringify(t))}},this._onStorage=function(t){t.key===e&&n._eventListeners.forEach((function(e){e(JSON.parse(t.oldValue),JSON.parse(t.newValue))}))};try{null==this._read()&&this.clear()}catch(e){this.clear()}}else{var i;this._storage={read:function(){return i},write:function(e){i=e}}}}return e.prototype._read=function(){return this._storage.read()},e.prototype._write=function(e){this._storage.write(e)},e.prototype.clear=function(){this._write(this._defaultValue)},e.prototype.addEventListener=function(e){0===this._eventListeners.length&&window.addEventListener("storage",this._onStorage),this._eventListeners.push(e)},e.prototype.removeEventListener=function(e){this._eventListeners.splice(this._eventListeners.findIndex((function(t){return t===e})),1),0===this._eventListeners.length&&window.removeEventListener("storage",this._onStorage)},e}();t.default=n},function(e,t,r){"use strict";var n,o=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(t,r,n){return void 0===n&&(n="localStorage"),e.call(this,t,r,n)||this}return o(t,e),t.prototype.get=function(){return this._read()},t.prototype.set=function(e){this._write(e)},t}(r(2).default);t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createUrl=void 0;var n=r(0),o=[{protocol:"http",port:80},{protocol:"https",port:443}];function i(e){return e.startsWith("/")?e:"/"+e}t.createUrl=function(e,t,r){var a=e.protocol+"://"+e.host;if(null!=e.port){var s=o.filter((function(t){return t.protocol===e.protocol}))[0];s&&s.port===e.port||(a+=":"+e.port)}return e.path&&(a+=i(e.path)),t&&(a+=i(t)),r&&(a+=n.createQueryString(r)),a}},function(e,t,r){"use strict";var n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return a},o=this&&this.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(n(arguments[t]));return e};Object.defineProperty(t,"__esModule",{value:!0});var i=r(6),a=r(9),s=r(14),c=r(4),u=r(15),l=r(16),d=r(17),p=r(0);function f(e){var t="/icons/";e.user?t+="icon-{SIZE}.png":t+="icon-{SIZE}-warning.png",chrome.browserAction.setIcon({path:[16,24,32,40,48].reduce((function(e,r){return e[r]=t.replace("{SIZE}",r.toString()),e}),{})})}var h=new(r(18).default),m=new a.default({onDisplayPreferenceChanged:function(e){g.displayPreferenceChanged(e),y.displayPreferenceChanged(e)},onUserSignedOut:function(){f({user:null}),g.userSignedOut()},onUserUpdated:function(e){f({user:e}),g.userUpdated(e),y.userUpdated(e)}}),g=new i.default({badgeApi:h,onGetDisplayPreference:function(){return m.getDisplayPreference()},onChangeDisplayPreference:function(e){return y.displayPreferenceChanged(e),m.changeDisplayPreference(e)},onRegisterPage:function(e,t){return m.registerPage(e,t).then((function(e){return y.articleUpdated({article:e.userArticle,isCompletionCommit:!1}),e}))},onCommitReadState:function(e,t,r){return console.log("contentScriptApi.onCommitReadState (tabId: "+e+")"),m.commitReadState(e,t).then((function(e){return y.articleUpdated({article:e,isCompletionCommit:r}),e}))},onLoadContentParser:function(e){try{if(new u.default(localStorage.getItem("contentParserVersion")).compareTo(new u.default("1.1.2"))>0)return console.log("contentScriptApi.onLoadContentParser (loading content parser from localStorage, tabId: "+e+")"),void chrome.tabs.executeScript(e,{code:localStorage.getItem("contentParserScript")})}catch(e){}console.log("contentScriptApi.onLoadContentParser (loading content parser from bundle, tabId: "+e+")"),chrome.tabs.executeScript(e,{file:"/content-scripts/reader/content-parser/bundle.js"})},onGetComments:function(e){return m.getComments(e)},onPostArticle:function(e){return m.postArticle(e).then((function(e){return y.articlePosted(e),y.articleUpdated({article:e.article,isCompletionCommit:!1}),e.comment&&y.commentPosted(l.createCommentThread(e)),e}))},onPostComment:function(e){return m.postComment(e).then((function(e){return y.articleUpdated({article:e.article,isCompletionCommit:!1}),y.commentPosted(e.comment),e}))},onPostCommentAddendum:function(e){return m.postCommentAddendum(e).then((function(e){return y.commentUpdated(e),e}))},onPostCommentRevision:function(e){return m.postCommentRevision(e).then((function(e){return y.commentUpdated(e),e}))},onRequestTwitterBrowserLinkRequestToken:function(){return m.requestTwitterBrowserLinkRequestToken()},onReportArticleIssue:function(e){return m.reportArticleIssue(e)},onSetStarred:function(e){return m.setStarred(e.articleId,e.isStarred).then((function(e){return y.articleUpdated({article:e,isCompletionCommit:!1}),e}))},onDeleteComment:function(e){return m.deleteComment(e).then((function(e){return y.commentUpdated(e),e}))}}),y=new s.default({onArticleUpdated:function(e){g.articleUpdated(e)},onAuthServiceLinkCompleted:function(e){g.authServiceLinkCompleted(e)},onDisplayPreferenceChanged:function(e){m.displayPreferenceChanged(e),g.displayPreferenceChanged(e)},onCommentPosted:function(e){g.commentPosted(e)},onCommentUpdated:function(e){g.commentUpdated(e)},onSubscriptionStatusChanged:function(e){g.subscriptionStatusChanged(e)},onUserSignedIn:function(e){f({user:e.userAccount}),m.userSignedIn(e)},onUserSignedOut:function(){f({user:null}),m.userSignedOut(),g.userSignedOut()},onUserUpdated:function(e){f({user:e}),m.userUpdated(e),g.userUpdated(e)}});chrome.runtime.onInstalled.addListener((function(e){console.log("[EventPage] installed, reason: "+e.reason),["sessionKey",d.sessionIdCookieKey].forEach((function(e){chrome.cookies.get({url:c.createUrl(Object({protocol:"https",host:"readup.com"})),name:e},(function(e){"unspecified"===(null==e?void 0:e.sameSite)&&chrome.cookies.set({url:c.createUrl(Object({protocol:"https",host:"readup.com"})),domain:e.domain,expirationDate:e.expirationDate,httpOnly:e.httpOnly,name:e.name,path:e.path,sameSite:"no_restriction",secure:e.secure,storeId:e.storeId,value:e.value})}))})),localStorage.removeItem("parseMode"),localStorage.removeItem("showOverlay"),localStorage.removeItem("newReplyNotification"),localStorage.removeItem("sourceRules"),localStorage.removeItem("articles"),localStorage.removeItem("tabs"),localStorage.setItem("debug",JSON.stringify(!1)),f({user:m.getUser()}),g.clearTabs(),y.clearTabs(),y.injectContentScripts(),chrome.runtime.getPlatformInfo((function(t){"install"===e.reason&&h.setLoading(),m.logExtensionInstallation({arch:t.arch,installationId:localStorage.getItem("installationId"),os:t.os}).then((function(t){var r;"install"===e.reason&&chrome.tabs.create({url:c.createUrl(Object({protocol:"https",host:"readup.com"}),t.redirectPath,(r={},r[p.extensionInstalledQueryStringKey]=null,r))}),t.installationId&&(chrome.runtime.setUninstallURL(c.createUrl(Object({protocol:"https",host:"readup.com"}),"/extension/uninstall",{installationId:t.installationId})),localStorage.setItem("installationId",t.installationId))})).catch((function(e){console.log("[EventPage] error logging installation"),e&&console.log(e)})).finally((function(){h.setDefault()}))})),chrome.alarms.create("updateContentParser",{when:Date.now(),periodInMinutes:120}),chrome.notifications&&chrome.alarms.create(a.default.alarms.checkNotifications,{when:Date.now(),periodInMinutes:2.5}),chrome.alarms.create(a.default.alarms.getBlacklist,{when:Date.now(),periodInMinutes:120}),chrome.alarms.clear("ServerApi.checkNewReplyNotification")})),chrome.runtime.onStartup.addListener((function(){console.log("[EventPage] startup"),f({user:m.getUser()}),g.clearTabs(),y.clearTabs(),y.injectContentScripts()})),chrome.browserAction.onClicked.addListener((function(e){var t;m.isAuthenticated()?e.url&&(e.url.startsWith(c.createUrl(Object({protocol:"https",host:"readup.com"})))?chrome.tabs.executeScript(e.id,{code:"if (!window.reallyreadit?.alertContentScript) { window.reallyreadit = { ...window.reallyreadit, alertContentScript: { alertContent: 'Press the Readup button when you\\'re on an article web page.' } }; chrome.runtime.sendMessage({ from: 'contentScriptInitializer', to: 'eventPage', type: 'injectAlert' }); } else if (!window.reallyreadit.alertContentScript.isActive) { window.reallyreadit.alertContentScript.display(); }"}):m.getBlacklist().some((function(t){return t.test(e.url)}))?chrome.tabs.executeScript(e.id,{code:"if (!window.reallyreadit?.alertContentScript) { window.reallyreadit = { ...window.reallyreadit, alertContentScript: { alertContent: 'No article detected on this web page.' } }; chrome.runtime.sendMessage({ from: 'contentScriptInitializer', to: 'eventPage', type: 'injectAlert' }); } else if (!window.reallyreadit.alertContentScript.isActive) { window.reallyreadit.alertContentScript.display(); }"}):chrome.tabs.executeScript(e.id,{code:"if (!window.reallyreadit?.readerContentScript) { window.reallyreadit = { ...window.reallyreadit, readerContentScript: { } }; chrome.runtime.sendMessage({ from: 'contentScriptInitializer', to: 'eventPage', type: 'injectReader' }); }"})):chrome.tabs.create({url:c.createUrl(Object({protocol:"https",host:"readup.com"}),null,(t={},t[p.extensionAuthQueryStringKey]=null,t))})})),chrome.runtime.onMessage.addListener((function(e,t){if("contentScriptInitializer"===e.from&&"eventPage"===e.to)switch(e.type){case"injectAlert":return void chrome.tabs.executeScript(t.tab.id,{file:"/content-scripts/alert/bundle.js"});case"injectReader":return void chrome.tabs.executeScript(t.tab.id,{file:"/content-scripts/reader/bundle.js"})}})),chrome.alarms.onAlarm.addListener((function(e){if("updateContentParser"===e.name){var t=u.default.greatest.apply(u.default,o(["1.1.2",localStorage.getItem("contentParserVersion")].filter((function(e){return!!e})).map((function(e){return new u.default(e)}))));console.log("chrome.alarms.onAlarm (updateContentParser: checking for new version. current version: "+t.toString()+")"),fetch(c.createUrl(Object({protocol:"https",host:"static.readup.com"}),"/extension/content-parser.txt")).then((function(e){return e.text()})).then((function(e){var r=e.split("\n").filter((function(e){return!!e})).map((function(e){return{fileName:e,version:new u.default(e)}})).find((function(e){return t.canUpgradeTo(e.version)}));r?(console.log("chrome.alarms.onAlarm (updateContentParser: updating to version: "+r.version.toString()+")"),fetch(c.createUrl(Object({protocol:"https",host:"static.readup.com"}),"/extension/content-parser/"+r.fileName)).then((function(e){return e.text()})).then((function(e){localStorage.setItem("contentParserScript",e),localStorage.setItem("contentParserVersion",r.version.toString())})).catch((function(){console.log("chrome.alarms.onAlarm (updateContentParser: error updating to new version)")}))):console.log("chrome.alarms.onAlarm (updateContentParser: no new version)")})).catch((function(){console.log("chrome.alarms.onAlarm (updateContentParser: error checking for new version)")}))}}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(7),o=r(1),i=r(8),a=function(){function e(e){var t=this;this._tabs=new o.default("readerTabs",(function(e){return e.id}),"localStorage"),this._badge=e.badgeApi,chrome.runtime.onMessage.addListener((function(r,o,a){var s;if("eventPage"===r.to&&"readerContentScript"===r.from)switch(console.log("[ReaderApi] received "+r.type+" message from tab # "+(null===(s=o.tab)||void 0===s?void 0:s.id)),r.type){case"getDisplayPreference":a({value:e.onGetDisplayPreference()});break;case"changeDisplayPreference":return t.sendMessageToOtherTabs(o.tab.id,{type:"displayPreferenceChanged",data:r.data}),n.createMessageResponseHandler(e.onChangeDisplayPreference(r.data),a),!0;case"registerPage":return t._tabs.set({articleId:null,id:o.tab.id}),t._badge.setLoading(o.tab.id),n.createMessageResponseHandler(e.onRegisterPage(o.tab.id,r.data).then((function(e){return t._tabs.set({articleId:e.userArticle.id,id:o.tab.id}),t._tabs.getAll().forEach((function(r){r.articleId===e.userArticle.id&&(t._badge.setReading(r.id,e.userArticle),chrome.browserAction.setTitle({tabId:r.id,title:i.calculateEstimatedReadTime(e.userArticle.wordCount)+" min. read"}))})),e})).catch((function(e){throw t._tabs.remove(o.tab.id),t._badge.setDefault(o.tab.id),e})),a),!0;case"commitReadState":return n.createMessageResponseHandler(e.onCommitReadState(o.tab.id,r.data.commitData,r.data.isCompletionCommit).then((function(e){return t._tabs.getAll().forEach((function(r){r.articleId===e.id&&t._badge.setReading(r.id,e)})),e})),a),!0;case"unregisterPage":t._tabs.remove(o.tab.id);break;case"loadContentParser":e.onLoadContentParser(o.tab.id);break;case"closeWindow":chrome.windows.remove(r.data,(function(){chrome.runtime.lastError&&console.log("[ReaderApi] error closing window, message: "+chrome.runtime.lastError.message)}));break;case"getComments":return n.createMessageResponseHandler(e.onGetComments(r.data),a),!0;case"hasWindowClosed":return n.createMessageResponseHandler(new Promise((function(e,t){chrome.windows.get(r.data,(function(t){chrome.runtime.lastError&&console.log("[ReaderApi] error getting window, message: "+chrome.runtime.lastError.message),e(!t)}))})),a),!0;case"openWindow":var c=r.data;return n.createMessageResponseHandler(new Promise((function(e,t){chrome.windows.create({type:"popup",url:c.url,width:c.width,height:c.height,focused:!0},(function(r){if(chrome.runtime.lastError)return console.log("[ReaderApi] error opening window, message: "+chrome.runtime.lastError.message),void t(chrome.runtime.lastError);e(r.id)}))})),a),!0;case"postArticle":return n.createMessageResponseHandler(e.onPostArticle(r.data),a),!0;case"postComment":return n.createMessageResponseHandler(e.onPostComment(r.data),a),!0;case"postCommentAddendum":return n.createMessageResponseHandler(e.onPostCommentAddendum(r.data),a),!0;case"postCommentRevision":return n.createMessageResponseHandler(e.onPostCommentRevision(r.data),a),!0;case"reportArticleIssue":return n.createMessageResponseHandler(e.onReportArticleIssue(r.data),a),!0;case"requestTwitterBrowserLinkRequestToken":return n.createMessageResponseHandler(e.onRequestTwitterBrowserLinkRequestToken(),a),!0;case"setStarred":return n.createMessageResponseHandler(e.onSetStarred(r.data),a),!0;case"deleteComment":return n.createMessageResponseHandler(e.onDeleteComment(r.data),a),!0}return!1}))}return e.prototype.broadcastMessage=function(e,t){var r=this;e.forEach((function(e){console.log("[ReaderApi] sending "+t.type+" message to tab # "+e.id),chrome.tabs.sendMessage(e.id,t,(function(){chrome.runtime.lastError&&(console.log("[ReaderApi] error sending message to tab # "+e.id+", message: "+chrome.runtime.lastError.message),r._tabs.remove(e.id))}))}))},e.prototype.sendMessageToAllTabs=function(e){this.broadcastMessage(this._tabs.getAll(),e)},e.prototype.sendMessageToOtherTabs=function(e,t){this.broadcastMessage(this._tabs.getAll().filter((function(t){return t.id!==e})),t)},e.prototype.sendMessageToArticleTabs=function(e,t){this.broadcastMessage(this._tabs.getAll().filter((function(t){return t.articleId===e})),t)},e.prototype.articleUpdated=function(e){this.sendMessageToArticleTabs(e.article.id,{type:"articleUpdated",data:e})},e.prototype.authServiceLinkCompleted=function(e){this.sendMessageToAllTabs({type:"authServiceLinkCompleted",data:e})},e.prototype.clearTabs=function(){this._tabs.clear()},e.prototype.commentPosted=function(e){this.sendMessageToArticleTabs(e.articleId,{type:"commentPosted",data:e})},e.prototype.commentUpdated=function(e){this.sendMessageToArticleTabs(e.articleId,{type:"commentUpdated",data:e})},e.prototype.displayPreferenceChanged=function(e){this.sendMessageToAllTabs({type:"displayPreferenceChanged",data:e})},e.prototype.subscriptionStatusChanged=function(e){this.sendMessageToAllTabs({type:"subscriptionStatusChanged",data:e})},e.prototype.userSignedOut=function(){var e=this;this.sendMessageToAllTabs({type:"userSignedOut"}),this._tabs.getAll().forEach((function(t){e._badge.setDefault(t.id)})),this._tabs.clear()},e.prototype.userUpdated=function(e){this.sendMessageToAllTabs({type:"userUpdated",data:e})},e}();t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createMessageResponseHandler=t.isSuccessResponse=void 0,t.isSuccessResponse=function(e){return"value"in e},t.createMessageResponseHandler=function(e,t){e.then((function(e){t({value:e})})).catch((function(e){e instanceof Error&&(e={message:e.message,name:e.name}),t({error:e})}))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateEstimatedReadTime=void 0,t.calculateEstimatedReadTime=function(e){return Math.max(1,Math.floor(e/184))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(1),o=r(3),i=r(10),a=r(4),s=r(0),c=r(11),u=r(13);function l(e,t){e.setRequestHeader("X-Readup-Client","web/extension@5.0.1")}var d=function(){function e(t){var r=this;this._displayedNotifications=new n.default("displayedNotifications",(function(e){return e.id})),this._displayPreference=new o.default("displayPreference",null),this._blacklist=new o.default("blacklist",{value:[],timestamp:0,expirationTimespan:0}),this._user=new o.default("user",null),chrome.alarms.onAlarm.addListener((function(t){if(r.isAuthenticated())switch(t.name){case e.alarms.checkNotifications:r.checkNotifications();break;case e.alarms.getBlacklist:r.checkBlacklistCache()}})),chrome.notifications&&chrome.notifications.onClicked.addListener((function(e){chrome.tabs.create({url:a.createUrl(Object({protocol:"https",host:"api.readup.com"}),"/Extension/Notification/"+e)})})),this._onDisplayPreferenceChanged=t.onDisplayPreferenceChanged,this._onUserSignedOut=t.onUserSignedOut,this._onUserUpdated=t.onUserUpdated}return e.prototype.checkNotifications=function(){var e=this;chrome.notifications&&chrome.notifications.getAll((function(t){var r=Date.now()-12e4,n=e._displayedNotifications.getAll().reduce((function(e,t){return t.date>=r?e.current.push(t):e.expired.push(t),e}),{current:[],expired:[]}),o=n.current;n.expired.forEach((function(t){e._displayedNotifications.remove(t.id)})),e.fetchJson({method:"GET",path:"/Extension/Notifications",data:{ids:Object.keys(t).concat(o.filter((function(e){return!(e.id in t)})).map((function(e){return e.id})))}}).then((function(t){t.cleared.forEach((function(t){chrome.notifications.clear(t),e._displayedNotifications.remove(t)})),t.created.forEach((function(t){chrome.notifications.create(t.id,{type:"basic",iconUrl:"../icons/icon.svg",title:t.title,message:t.message,isClickable:!0}),e._displayedNotifications.set({id:t.id,date:Date.now()})}));var r=e.getUser();c.areEqual(r,t.user)||(e._user.set(t.user),r&&(console.log("[ServerApi] user updated (notification check)"),e._onUserUpdated(t.user)))})).catch((function(){}))}))},e.prototype.checkBlacklistCache=function(){var e=this;i.isExpired(this._blacklist.get())&&this.fetchJson({method:"GET",path:"/Extension/Blacklist"}).then((function(t){return e._blacklist.set(i.cache(t,719e3))})).catch((function(){}))},e.prototype.fetchJson=function(e){var t=this;return new Promise((function(r,n){var o=new XMLHttpRequest,i=a.createUrl(Object({protocol:"https",host:"api.readup.com"}),e.path);o.withCredentials=!0,o.addEventListener("load",(function(){var e,o=this.getResponseHeader("Content-Type");((null==o?void 0:o.startsWith("application/json"))||(null==o?void 0:o.startsWith("application/problem+json")))&&(e=JSON.parse(this.responseText)),200===this.status?e?r(e):r():(401===this.status&&(console.log("[ServerApi] user signed out (received 401 response from API server)"),t.userSignedOut(),t._onUserSignedOut()),n(e||["ServerApi XMLHttpRequest load event. Status: "+this.status+" Status text: "+this.statusText+" Response text: "+this.responseText]))})),o.addEventListener("error",(function(){n(["ServerApi XMLHttpRequest error event"])})),"POST"===e.method?(o.open(e.method,i),l(o),o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify(e.data))):(o.open(e.method,i+s.createQueryString(e.data)),l(o),o.send())}))},e.prototype.registerPage=function(e,t){return this.fetchJson({method:"POST",path:"/Extension/GetUserArticle",data:t,id:e})},e.prototype.getComments=function(e){return this.fetchJson({method:"GET",path:"/Articles/ListComments",data:{slug:e}})},e.prototype.postArticle=function(e){return this.fetchJson({method:"POST",path:"/Social/Post",data:e})},e.prototype.postComment=function(e){return this.fetchJson({method:"POST",path:"/Social/Comment",data:e})},e.prototype.postCommentAddendum=function(e){return this.fetchJson({method:"POST",path:"/Social/CommentAddendum",data:e})},e.prototype.postCommentRevision=function(e){return this.fetchJson({method:"POST",path:"/Social/CommentRevision",data:e})},e.prototype.deleteComment=function(e){return this.fetchJson({method:"POST",path:"/Social/CommentDeletion",data:e})},e.prototype.commitReadState=function(e,t){return this.fetchJson({method:"POST",path:"/Extension/CommitReadState",data:t})},e.prototype.isAuthenticated=function(){return null!=this.getUser()},e.prototype.getUser=function(){return this._user.get()},e.prototype.getBlacklist=function(){return this._blacklist.get().value.map((function(e){return new RegExp(e)}))},e.prototype.rateArticle=function(e,t){return this.fetchJson({method:"POST",path:"/Articles/Rate",data:{articleId:e,score:t}})},e.prototype.reportArticleIssue=function(e){return this.fetchJson({method:"POST",path:"/Analytics/ArticleIssueReport",data:e})},e.prototype.requestTwitterBrowserLinkRequestToken=function(){return this.fetchJson({method:"POST",path:"/Auth/TwitterBrowserLinkRequest"})},e.prototype.setStarred=function(e,t){return this.fetchJson({method:"POST",path:"/Extension/SetStarred",data:{articleId:e,isStarred:t}})},e.prototype.logExtensionInstallation=function(e){return this.fetchJson({method:"POST",path:"/Extension/Install",data:e})},e.prototype.userSignedIn=function(e){this._user.set(e.userAccount),this._displayPreference.set(e.displayPreference),this.checkNotifications()},e.prototype.userSignedOut=function(){this._user.clear(),this._displayPreference.clear(),this._displayedNotifications.clear()},e.prototype.userUpdated=function(e){this._user.set(e||null)},e.prototype.getDisplayPreference=function(){var e=this,t=this._displayPreference.get();return this.fetchJson({method:"GET",path:"/UserAccounts/DisplayPreference"}).then((function(r){null!=t&&null!=r&&u.areEqual(t,r)||(r?e.displayPreferenceChanged(r):e.changeDisplayPreference(r=u.getClientDefaultDisplayPreference()),console.log("[ServerApi] display preference changed"),e._onDisplayPreferenceChanged(r))})).catch((function(){console.log("[ServerApi] error fetching display preference")})),t},e.prototype.displayPreferenceChanged=function(e){this._displayPreference.set(e)},e.prototype.changeDisplayPreference=function(e){return this.displayPreferenceChanged(e),this.fetchJson({method:"POST",path:"/UserAccounts/DisplayPreference",data:e})},e.alarms={checkNotifications:"ServerApi.checkNotifications",getBlacklist:"ServerApi.getBlacklist"},e}();t.default=d},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isExpired=t.cache=void 0,t.cache=function(e,t){return{value:e,timestamp:Date.now(),expirationTimespan:t}},t.isExpired=function(e){return Date.now()-e.timestamp>e.expirationTimespan}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasAnyAlerts=t.areEqual=void 0;var n=r(12);t.areEqual=function(e,t){return!(!e||!t)&&(e.id===t.id&&e.name===t.name&&e.email===t.email&&e.dateCreated===t.dateCreated&&e.role===t.role&&e.isEmailConfirmed===t.isEmailConfirmed&&e.timeZoneId===t.timeZoneId&&e.aotdAlert===t.aotdAlert&&e.replyAlertCount===t.replyAlertCount&&e.loopbackAlertCount===t.loopbackAlertCount&&e.postAlertCount===t.postAlertCount&&e.followerAlertCount===t.followerAlertCount&&e.isPasswordSet===t.isPasswordSet&&e.hasLinkedTwitterAccount===t.hasLinkedTwitterAccount&&e.dateOrientationCompleted===t.dateOrientationCompleted)},t.hasAnyAlerts=function(e,t){return!!e&&(null!=t?!!(t&n.default.Aotd&&e.aotdAlert)||(!!(t&n.default.Reply&&e.replyAlertCount)||(!!(t&n.default.Loopback&&e.loopbackAlertCount)||(!!(t&n.default.Post&&e.postAlertCount)||!!(t&n.default.Follower&&e.followerAlertCount)))):!!(e.aotdAlert||e.replyAlertCount||e.loopbackAlertCount||e.postAlertCount||e.followerAlertCount))}},function(e,t,r){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Aotd=1]="Aotd",e[e.Reply=2]="Reply",e[e.Loopback=4]="Loopback",e[e.Post=8]="Post",e[e.Follower=16]="Follower"}(n||(n={})),t.default=n},function(e,t,r){"use strict";var n;function o(){return window.matchMedia("(prefers-color-scheme: dark)").matches?n.Dark:n.Light}Object.defineProperty(t,"__esModule",{value:!0}),t.getDisplayPreferenceChangeMessage=t.getClientDefaultDisplayPreference=t.getClientPreferredColorScheme=t.areEqual=t.DisplayTheme=void 0,function(e){e[e.Light=1]="Light",e[e.Dark=2]="Dark"}(n=t.DisplayTheme||(t.DisplayTheme={})),t.areEqual=function(e,t){return e.hideLinks===t.hideLinks&&e.textSize===t.textSize&&e.theme===t.theme},t.getClientPreferredColorScheme=o,t.getClientDefaultDisplayPreference=function(){return{hideLinks:!0,textSize:1,theme:o()}},t.getDisplayPreferenceChangeMessage=function(e,t){var r;return t.hideLinks!==e.hideLinks?r="Links "+(t.hideLinks?"Disabled":"Enabled"):t.textSize!==e.textSize?r="Text Size "+(t.textSize>e.textSize?"Increased":"Decreased"):t.theme!==e.theme&&(r=(t.theme===n.Dark?"Dark":"Light")+" Theme Enabled"),r}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3),o=function(){function e(e){var t=this;this._tabs=new n.default("webAppTabs",[],"localStorage"),chrome.runtime.onMessage.addListener((function(r,n){var o;if("eventPage"===r.to&&"webAppContentScript"===r.from)switch(console.log("[WebAppApi] received "+r.type+" message from tab # "+(null===(o=n.tab)||void 0===o?void 0:o.id)),r.type){case"articleUpdated":e.onArticleUpdated(r.data);break;case"authServiceLinkCompleted":e.onAuthServiceLinkCompleted(r.data);break;case"commentPosted":e.onCommentPosted(r.data);break;case"commentUpdated":e.onCommentUpdated(r.data);break;case"displayPreferenceChanged":e.onDisplayPreferenceChanged(r.data);break;case"registerPage":t.addTab(n.tab.id);break;case"subscriptionStatusChanged":e.onSubscriptionStatusChanged(r.data);break;case"unregisterPage":t.removeTab(n.tab.id);break;case"userSignedIn":e.onUserSignedIn(r.data);break;case"userSignedOut":e.onUserSignedOut();break;case"userUpdated":e.onUserUpdated(r.data)}return!1}))}return e.prototype.addTab=function(e){var t=this._tabs.get();t.includes(e)||(t.push(e),this._tabs.set(t))},e.prototype.broadcastMessage=function(e){var t=this;this._tabs.get().forEach((function(r){console.log("[WebAppApi] sending "+e.type+" message to tab # "+r),chrome.tabs.sendMessage(r,e,(function(){chrome.runtime.lastError&&(console.log("[WebAppApi] error sending message to tab # "+r+", message: "+chrome.runtime.lastError.message),t.removeTab(r))}))}))},e.prototype.removeTab=function(e){var t=this._tabs.get();t.includes(e)&&(t.splice(t.indexOf(e),1),this._tabs.set(t))},e.prototype.articlePosted=function(e){this.broadcastMessage({type:"articlePosted",data:e})},e.prototype.articleUpdated=function(e){this.broadcastMessage({type:"articleUpdated",data:e})},e.prototype.clearTabs=function(){this._tabs.clear()},e.prototype.commentPosted=function(e){this.broadcastMessage({type:"commentPosted",data:e})},e.prototype.commentUpdated=function(e){this.broadcastMessage({type:"commentUpdated",data:e})},e.prototype.displayPreferenceChanged=function(e){this.broadcastMessage({type:"displayPreferenceChanged",data:e})},e.prototype.injectContentScripts=function(){chrome.tabs.query({url:"https://readup.com/*",status:"complete"},(function(e){chrome.runtime.lastError?console.log("[WebAppApi] error querying tabs"):e.forEach((function(e){var t;(null===(t=e.url)||void 0===t?void 0:t.startsWith("https://readup.com/"))&&(console.log("[WebAppApi] injecting content script into tab # "+e.id),chrome.tabs.executeScript(e.id,{file:"/content-scripts/web-app/bundle.js"}))}))}))},e.prototype.userUpdated=function(e){this.broadcastMessage({type:"userUpdated",data:e})},e}();t.default=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){var t=e.match(/(\d+)\.(\d+)\.(\d+)/);if(!t)throw new Error("Invalid version format");this._major=parseInt(t[1]),this._minor=parseInt(t[2]),this._patch=parseInt(t[3])}return e.greatest=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.sort((function(e,t){return t.compareTo(e)}))[0]},e.prototype.canUpgradeTo=function(e){return e.major===this._major&&(e.minor>this._minor||e.minor===this._minor&&e.patch>this._patch)},e.prototype.compareTo=function(e){return this._major!==e._major?this._major-e._major:this._minor!==e._minor?this._minor-e._minor:this._patch!==e._patch?this._patch-e._patch:0},e.prototype.toString=function(){return this._major+"."+this._minor+"."+this._patch},Object.defineProperty(e.prototype,"major",{get:function(){return this._major},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"minor",{get:function(){return this._minor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"patch",{get:function(){return this._patch},enumerable:!1,configurable:!0}),e}();t.default=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createCommentThread=void 0,t.createCommentThread=function(e){return{id:e.comment&&e.comment.id||"",dateCreated:e.date,text:e.comment&&e.comment.text||"",addenda:e.comment&&e.comment.addenda||[],articleId:e.article.id,articleTitle:e.article.title,articleSlug:e.article.slug,userAccount:e.userName,badge:e.badge,isAuthor:!1,parentCommentId:null,dateDeleted:e.dateDeleted,children:[]}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sessionIdCookieKey=t.extensionVersionCookieKey=t.extensionInstallationRedirectPathCookieKey=void 0,t.extensionInstallationRedirectPathCookieKey="extensionInstallationRedirectPath",t.extensionVersionCookieKey="extensionVersion",t.sessionIdCookieKey="sessionId"},function(e,t,r){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Default="#555555",e.Read="#32CD32",e.Unread="#A9A9A9"}(n||(n={}));var o=function(){function e(){this._animations=[]}return e.prototype.cancelAnimation=function(e){var t=this.getAnimation(e);t&&(console.log("[BrowserActionBadgeApi] cancelling loading animation for tab # "+e),clearInterval(t.interval),this._animations.splice(this._animations.indexOf(t),1))},e.prototype.getAnimation=function(e){return this._animations.find((function(t){return t.tabId===e}))},e.prototype.setDefault=function(e){void 0===e&&(e=null),this.cancelAnimation(e),chrome.browserAction.setBadgeBackgroundColor({color:n.Default,tabId:e}),chrome.browserAction.setBadgeText({tabId:e,text:""})},e.prototype.setLoading=function(e){void 0===e&&(e=null),this.getAnimation(e)||(console.log("[BrowserActionBadgeApi] creating loading animation for tab # "+e),this._animations.push(function(e){var t=0;return chrome.browserAction.setBadgeBackgroundColor({color:n.Default,tabId:e}),{interval:window.setInterval((function(){for(var r="",n=0;n<4;n++)r+=n===t?".":String.fromCharCode(8200);chrome.browserAction.setBadgeText({tabId:e,text:r}),t=++t%5}),150),tabId:e}}(e)))},e.prototype.setReading=function(e,t){console.log("[BrowserActionBadgeApi] setting progress at "+Math.floor(t.percentComplete)+"% for tab # "+e),this.cancelAnimation(e),chrome.browserAction.setBadgeBackgroundColor({color:t.isRead?n.Read:n.Unread,tabId:e}),chrome.browserAction.setBadgeText({tabId:e,text:Math.floor(t.percentComplete)+"%"})},e}();t.default=o}]);